name: Build Release APK (Production)

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      version_code:
        description: 'Version code (integer)'
        required: true
        default: '1'

jobs:
  build-release-apk:
    runs-on: ubuntu-latest

    steps:
      # ===============================
      # 1. Checkout Code
      # ===============================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===============================
      # 2. Setup Node.js
      # ===============================
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Verify Node & NPM
        run: |
          echo "======================================"
          echo "üöÄ FAST HAAZIR - PRODUCTION BUILD"
          echo "======================================"
          echo "Version: ${{ github.event.inputs.version_name }}"
          echo "Build: ${{ github.event.inputs.version_code }}"
          echo "======================================"
          node -v
          npm -v

      # ===============================
      # 3. Setup Java (Android)
      # ===============================
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ===============================
      # 4. Install Frontend Dependencies
      # ===============================
      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          npm install --legacy-peer-deps

      # ===============================
      # 5. Create Production .env
      # ===============================
      - name: Create production .env file
        working-directory: frontend
        run: |
          cat << EOF > .env
          VITE_SUPABASE_URL=https://pmqkclhqvjfmcxzuoypa.supabase.co
          VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtcWtjbGhxdmpmbWN4enVveXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODY2MTEsImV4cCI6MjA4MjA2MjYxMX0.EObJ4bGppAue12-eXk-CjWTCvSaqEKRpVeObJ7O7r64
          VITE_SUPABASE_PROJECT_ID=pmqkclhqvjfmcxzuoypa
          NODE_ENV=production
          VITE_APP_VERSION=${{ github.event.inputs.version_name }}
          VITE_BUILD_NUMBER=${{ github.event.inputs.version_code }}
          EOF

      # ===============================
      # 6. Validate Firebase Config
      # ===============================
      - name: Validate google-services.json
        working-directory: frontend/android/app
        run: |
          echo "======================================"
          echo "üîç Validating Firebase Configuration"
          echo "======================================"
          
          if [ ! -f "google-services.json" ]; then
            echo "‚ùå ERROR: google-services.json not found!"
            exit 1
          fi
          
          echo "‚úÖ google-services.json found"
          
          PROJECT_ID=$(grep -o '"project_id": "[^"]*' google-services.json | cut -d'"' -f4)
          if [ "$PROJECT_ID" != "fast-haazir-786" ]; then
            echo "‚ùå ERROR: Invalid project_id: $PROJECT_ID (expected: fast-haazir-786)"
            exit 1
          fi
          echo "‚úÖ Firebase project_id verified: $PROJECT_ID"
          
          PACKAGE_NAME=$(grep -o '"package_name": "[^"]*' google-services.json | cut -d'"' -f4 | head -1)
          if [ "$PACKAGE_NAME" != "com.fasthaazir.app" ]; then
            echo "‚ùå ERROR: Invalid package_name: $PACKAGE_NAME (expected: com.fasthaazir.app)"
            exit 1
          fi
          echo "‚úÖ Package name verified: $PACKAGE_NAME"
          
          echo "======================================"
          echo "‚úÖ Firebase configuration valid"
          echo "======================================"

      # ===============================
      # 7. Build Web App (Vite)
      # ===============================
      - name: Build web app
        working-directory: frontend
        run: npm run build
        env:
          CI: false
          NODE_ENV: production

      # ===============================
      # 8. Update Version in build.gradle
      # ===============================
      - name: Update version in build.gradle
        working-directory: frontend/android/app
        run: |
          sed -i "s/versionCode [0-9]*/versionCode ${{ github.event.inputs.version_code }}/" build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"${{ github.event.inputs.version_name }}\"/" build.gradle
          echo "‚úÖ Updated version to ${{ github.event.inputs.version_name }} (${{ github.event.inputs.version_code }})"

      # ===============================
      # 9. Sync Capacitor Android
      # ===============================
      - name: Sync Capacitor Android
        working-directory: frontend
        run: npx cap sync android

      # ===============================
      # 10. Prepare Gradle
      # ===============================
      - name: Make gradlew executable
        working-directory: frontend/android
        run: chmod +x gradlew

      # ===============================
      # 11. Build RELEASE APK (Unsigned)
      # ===============================
      - name: Build Release APK
        working-directory: frontend/android
        run: ./gradlew assembleRelease

      # ===============================
      # 12. Sign APK (Debug Key for Testing)
      # ===============================
      - name: Sign APK with debug key
        working-directory: frontend/android
        run: |
          # Create debug keystore if not exists
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkeypair \
              -alias androiddebugkey \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -keypass android \
              -dname "CN=Fast Haazir,O=Fast Haazir,C=PK"
          fi
          
          # Find and sign the APK
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$APK_PATH" ]; then
            echo "Found APK: $APK_PATH"
            
            # Use apksigner for proper signing
            ${ANDROID_SDK_ROOT}/build-tools/34.0.0/apksigner sign \
              --ks ~/.android/debug.keystore \
              --ks-key-alias androiddebugkey \
              --ks-pass pass:android \
              --key-pass pass:android \
              --out app/build/outputs/apk/release/fast-haazir-v${{ github.event.inputs.version_name }}-signed.apk \
              "$APK_PATH"
            
            echo "‚úÖ APK signed successfully"
          else
            echo "‚ö†Ô∏è No APK found to sign, using unsigned"
          fi

      # ===============================
      # 13. Upload Release APK
      # ===============================
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: fast-haazir-release-v${{ github.event.inputs.version_name }}
          path: |
            frontend/android/app/build/outputs/apk/release/*.apk
          retention-days: 90

      # ===============================
      # 14. Build Summary
      # ===============================
      - name: Build Success Summary
        run: |
          echo "======================================"
          echo "‚úÖ RELEASE APK BUILD SUCCESSFUL"
          echo "======================================"
          echo "üì± App: Fast Haazir"
          echo "üì¶ Package: com.fasthaazir.app"
          echo "üè∑Ô∏è Version: ${{ github.event.inputs.version_name }}"
          echo "üî¢ Build: ${{ github.event.inputs.version_code }}"
          echo "üî• Firebase: fast-haazir-786"
          echo "üóÑÔ∏è Supabase: pmqkclhqvjfmcxzuoypa"
          echo "======================================"
          echo ""
          echo "üìã FEATURES INCLUDED:"
          echo "   ‚úÖ Order Food, Grocery, Assign Rider"
          echo "   ‚úÖ Rider GPS tracking"
          echo "   ‚úÖ OTP verification for deliveries"
          echo "   ‚úÖ Admin wallet adjustments"
          echo "   ‚úÖ Real-time order updates"
          echo "   ‚úÖ Push notifications"
          echo "   ‚úÖ Bilingual (EN/UR) support"
          echo ""
          echo "üîê PRODUCTION NOTES:"
          echo "   1. SHA keys MUST be added to Firebase Console"
          echo "   2. Phone OTP works with real numbers only"
          echo "   3. Google Sign-In uses redirect method"
          echo "   4. Test on real device before Play Store"
          echo "======================================"
          echo "üöÄ READY FOR FINAL TESTING & RELEASE"
          echo "======================================"
