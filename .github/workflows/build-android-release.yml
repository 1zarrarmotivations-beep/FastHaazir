name: Build Signed Android APK (Production)

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.0)'
        required: false
        default: '1.0.0'
      version_code:
        description: 'Version code (integer)'
        required: false
        default: '1'
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  # Supabase Production Config
  SUPABASE_PROJECT_ID: 'pmqkclhqvjfmcxzuoypa'
  SUPABASE_URL: 'https://pmqkclhqvjfmcxzuoypa.supabase.co'
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtcWtjbGhxdmpmbWN4enVveXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODY2MTEsImV4cCI6MjA4MjA2MjYxMX0.EObJ4bGppAue12-eXk-CjWTCvSaqEKRpVeObJ7O7r64'

jobs:
  build-signed-apk:
    name: Build Production APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto-detect frontend path
        id: detect-frontend
        run: |
          if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
            echo "FRONTEND_PATH=frontend" >> $GITHUB_OUTPUT
            echo "ANDROID_PATH=frontend/android" >> $GITHUB_OUTPUT
            echo "Frontend detected at: frontend/"
          elif [ -f "package.json" ] && [ -d "src" ]; then
            echo "FRONTEND_PATH=." >> $GITHUB_OUTPUT
            echo "ANDROID_PATH=android" >> $GITHUB_OUTPUT
            echo "Frontend detected at: root"
          else
            echo "ERROR: Could not detect frontend path"
            exit 1
          fi

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: |
            ${{ steps.detect-frontend.outputs.FRONTEND_PATH }}/yarn.lock
            ${{ steps.detect-frontend.outputs.FRONTEND_PATH }}/package-lock.json

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Install dependencies
        working-directory: ${{ steps.detect-frontend.outputs.FRONTEND_PATH }}
        run: |
          if [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile || yarn install
          else
            npm ci || npm install
          fi

      - name: Create production .env file
        working-directory: ${{ steps.detect-frontend.outputs.FRONTEND_PATH }}
        run: |
          cat > .env << EOF
          VITE_SUPABASE_PROJECT_ID=${{ env.SUPABASE_PROJECT_ID }}
          VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.SUPABASE_ANON_KEY || env.SUPABASE_ANON_KEY }}
          VITE_SUPABASE_URL=${{ env.SUPABASE_URL }}
          EOF
          echo "âœ… Production .env created"

      - name: Build web assets
        working-directory: ${{ steps.detect-frontend.outputs.FRONTEND_PATH }}
        run: yarn build || npm run build
        env:
          CI: false
          NODE_ENV: production

      - name: Verify dist folder exists
        working-directory: ${{ steps.detect-frontend.outputs.FRONTEND_PATH }}
        run: |
          if [ ! -d "dist" ]; then
            echo "ERROR: dist folder not found after build"
            exit 1
          fi
          echo "âœ… Build output verified:"
          ls -la dist/ | head -20

      - name: Initialize Capacitor Android (if missing)
        working-directory: ${{ steps.detect-frontend.outputs.FRONTEND_PATH }}
        run: |
          if [ ! -d "android" ]; then
            echo "Android folder missing, adding Capacitor Android..."
            npx cap add android
          fi

      - name: Sync Capacitor to Android
        working-directory: ${{ steps.detect-frontend.outputs.FRONTEND_PATH }}
        run: npx cap sync android

      - name: Set gradlew executable
        working-directory: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}
        run: chmod +x gradlew

      - name: Update version in build.gradle (if provided)
        if: ${{ github.event.inputs.version_code || github.event.inputs.version_name }}
        working-directory: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}/app
        run: |
          VERSION_CODE="${{ github.event.inputs.version_code || '1' }}"
          VERSION_NAME="${{ github.event.inputs.version_name || '1.0.0' }}"
          
          # Update versionCode
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" build.gradle
          
          # Update versionName
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION_NAME\"/" build.gradle
          
          echo "âœ… Updated to versionCode=$VERSION_CODE, versionName=$VERSION_NAME"

      # ==================== SIGNED RELEASE BUILD ====================
      
      - name: Decode Keystore
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}/app
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release-keystore.jks
          echo "âœ… Keystore decoded successfully"

      - name: Build Signed Release APK
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$PWD/app/release-keystore.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
            --no-daemon --stacktrace

      - name: Build Signed Release AAB (Play Store)
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}
        run: |
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$PWD/app/release-keystore.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
            --no-daemon --stacktrace

      # ==================== UNSIGNED (FALLBACK) ====================

      - name: Build Unsigned Release APK (fallback)
        if: ${{ secrets.KEYSTORE_BASE64 == '' }}
        working-directory: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}
        run: |
          echo "âš ï¸ No keystore provided - building unsigned APK"
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Build Debug APK (always)
        working-directory: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}
        run: ./gradlew assembleDebug --no-daemon --stacktrace

      # ==================== ARTIFACTS ====================

      - name: List build outputs
        working-directory: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}
        run: |
          echo "=== APK Files ==="
          find . -name "*.apk" -type f 2>/dev/null || echo "No APKs found"
          echo ""
          echo "=== AAB Files ==="
          find . -name "*.aab" -type f 2>/dev/null || echo "No AABs found"

      - name: Upload Signed Release APK
        uses: actions/upload-artifact@v4
        with:
          name: fast-haazir-release-apk-signed
          path: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}/app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: warn

      - name: Upload Release AAB (Play Store)
        uses: actions/upload-artifact@v4
        with:
          name: fast-haazir-release-aab
          path: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}/app/build/outputs/bundle/release/*.aab
          retention-days: 90
          if-no-files-found: warn

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: fast-haazir-debug-apk
          path: ${{ steps.detect-frontend.outputs.ANDROID_PATH }}/app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: warn

      # ==================== GITHUB RELEASE ====================

      - name: Upload to GitHub Release
        if: github.event_name == 'release' && secrets.KEYSTORE_BASE64 != ''
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.detect-frontend.outputs.ANDROID_PATH }}/app/build/outputs/apk/release/*.apk
            ${{ steps.detect-frontend.outputs.ANDROID_PATH }}/app/build/outputs/bundle/release/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== BUILD SUMMARY ====================

      - name: Build Summary
        run: |
          echo "## ðŸš€ Fast Haazir Production Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Java**: ${{ env.JAVA_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed**: ${{ secrets.KEYSTORE_BASE64 != '' && 'âœ… Yes' || 'âŒ No (unsigned)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "- **Release APK**: Ready for distribution" >> $GITHUB_STEP_SUMMARY
          echo "- **Release AAB**: Ready for Play Store" >> $GITHUB_STEP_SUMMARY
          echo "- **Debug APK**: Ready for testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required GitHub Secrets for Signed Builds" >> $GITHUB_STEP_SUMMARY
          echo "1. \`KEYSTORE_BASE64\` - Base64-encoded keystore file" >> $GITHUB_STEP_SUMMARY
          echo "2. \`KEYSTORE_PASSWORD\` - Keystore password" >> $GITHUB_STEP_SUMMARY
          echo "3. \`KEY_ALIAS\` - Key alias in keystore" >> $GITHUB_STEP_SUMMARY
          echo "4. \`KEY_PASSWORD\` - Key password" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Firebase Setup Required" >> $GITHUB_STEP_SUMMARY
          echo "1. Add SHA-1 & SHA-256 fingerprints to Firebase Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Download \`google-services.json\` and place in \`android/app/\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Enable Phone Authentication in Firebase Console" >> $GITHUB_STEP_SUMMARY
